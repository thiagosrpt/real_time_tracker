<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Add a default marker</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
<script src="pathstations.json"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  .map-overlay {
    position: absolute;
    left: 0;
    padding: 10px;
  }

</style>
</head>
<body>

<div id="map"></div>
<div class="map-overlay top">
  <button style="font-size: 2em" onclick="run()">
    Update ETA
  </button>
</div>

<script>

var markers = []
stations = pathStations.stations;

function run(){
  refreshMarkers();
  stations.forEach(async function(station) {

    //gets station status
    let stationStatus = await getPathStations(station.station.toLowerCase());

    // creates marker popup with details from get station status
    let html = getHtmlDetails(stationStatus);
    const popup = new mapboxgl.Popup({ offset: 25 })
      .setHTML(
        `
        <h3>${station.name}</h3>
        ${html}
        `
    )

    // creates the marker and popup
    marker = new mapboxgl.Marker()
      .setLngLat([station.coordinates.longitude, station.coordinates.latitude])
      .setPopup(popup)
      .addTo(map);

    markers.push(marker);
  });
}

function refreshMarkers(){
  markers.forEach((marker) => {
    marker.remove();
  });
}


//returns HTML for popups
function getHtmlDetails(stationStatus) {
  let html = '';

  stationStatus.forEach((item) => {
    var headsign = item['headsign'];
    var status = item.status.toLowerCase();
    status = status.replace("_"," ");
    var projectedArrival = item['projectedArrival']
    const eta = new Date(projectedArrival).toLocaleTimeString(undefined, {
          timeZone: "America/New_York",
          hour: 'numeric',
          minute: 'numeric'
    });

    html = html + `
    <hr>
    <p>
      <span>
        ${headsign}: ${status} <br>
        ETA: ${eta} <br>
      </span>
    </p>
    `;
  });

  return html;
}

async function getPathStations(station){
	const url = `https://path.api.razza.dev/v1/stations/${station}/realtime`;
	const response = await fetch(url);
	const json     = await response.json();
	return json.upcomingTrains;
}


mapboxgl.accessToken = 'pk.eyJ1IjoidGhpYWdvc3JwdCIsImEiOiJjbDVnNWdjb2IxNnF5M2pudHoyZzFvbGxvIn0.VyGTgv1AGc4I3gNVzfroOQ';

var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-74.06289,40.73301],
        zoom: 12
    });



run();


</script>
</body>
</html>